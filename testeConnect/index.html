<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dados do Banco de Dados</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1>Dados do Banco de Dados</h1>
    <button onclick="reload_table()">recarregar tabela</button>
    <table id="tabela">
        <thead>
            <tr>
                <th>Projetista</th>
                <th>Nome da Obra</th>
                <th>Endereço</th>
                <th>Torre</th>
                <th>Data do Concreto</th>
                <th>Pavimento Ativo</th>
                <th>Pilar</th>
                <th>Cor do Pilar</th>
                <th>Grade</th>
                <th>Cor da Grade</th>
                <th>Viga</th>
                <th>Cor da Viga</th>
                <th>Garfo</th>
                <th>Cor do Garfo</th>
                <th>Laje</th>
                <th>Cor da Laje</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <form id="formDados">
        <input type="text" name="projetista" placeholder="Projetista" required>
        <input type="text" name="nome_obra" placeholder="Nome da Obra" required>
        <input type="text" name="endereco" placeholder="Endereço" required>
        <input type="text" name="torre" placeholder="Torre" required>
        <input type="date" name="data_concreto" required>
        <input type="text" name="pavimento_ativo" placeholder="Pavimento Ativo" required>
        <input type="text" name="pilar" placeholder="Pilar" required>
        <input type="text" name="cor_pilar" placeholder="Cor do Pilar" required>
        <input type="text" name="grade" placeholder="Grade" required>
        <input type="text" name="cor_grade" placeholder="Cor da Grade" required>
        <input type="text" name="viga" placeholder="Viga" required>
        <input type="text" name="cor_viga" placeholder="Cor da Viga" required>
        <input type="text" name="garfo" placeholder="Garfo" required>
        <input type="text" name="cor_garfo" placeholder="Cor do Garfo" required>
        <input type="text" name="laje" placeholder="Laje" required>
        <input type="text" name="cor_laje" placeholder="Cor da Laje" required>
        <button onclick="insert_bd_obra()">Inserir Dados</button>
        <button onclick="update_obra()">att obra</button>
    </form>
    <form id="pavimento">
        <input type="text" name="obra_nome" placeholder="Nome da obra" required>
        <input type="text" name="nome_pavimento" placeholder="Nome do pavimento" required>
        <input type="date" name="data_prev" required>
        <button onclick="insert_pavimento()">Inserir pavimento</button>
    </form>

    <script>
        reload_table()
        // get no servidor node com os dados do select * from obras
        function reload_table() {
            console.log(`Iniciando reload_table()`);
            const tbody = document.querySelector('#tabela tbody');
            // limpar a tabela
            tbody.innerHTML = '';
            fetch('http://localhost:3000/api/dados')
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#tabela tbody');
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.projetista}</td>
                        <td>${item.nome_obra}</td>
                        <td>${item.endereco}</td>
                        <td>${item.torre}</td>
                        <td>${item.data_concreto}</td>
                        <td>${item.pavimento_ativo}</td>
                        <td>${item.pilar}</td>
                        <td>${item.cor_pilar}</td>
                        <td>${item.grade}</td>
                        <td>${item.cor_grade}</td>
                        <td>${item.viga}</td>
                        <td>${item.cor_viga}</td>
                        <td>${item.garfo}</td>
                        <td>${item.cor_garfo}</td>
                        <td>${item.laje}</td>
                        <td>${item.cor_laje}</td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => console.error('Erro:', error));
            console.log(`Finalizado reload_table()`);
        }

        //enviar post para insert no banco de dados
        function insert_bd_obra() {
            event.preventDefault();
            console.log(`Iniciando insert_bd_obra()`);
            const formData = new FormData(document.getElementById('formDados'));
            const data = Object.fromEntries(formData.entries());
            fetch('http://localhost:3000/api/dados', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                console.log('response: ',response)
                if (!response.ok) {
                    throw new Error('Erro ao inserir dados: ' + response.statusText)
                }
                return response.json()
            })
            .then(data => {
                alert(data.message);
                reload_table();
            })
            .catch((error) => {
                alert(error);
                });
            console.log(`Finalizado insert_bd_obra()`);
            document.getElementById('formDados').reset()
        }

        //enviar put para atualizar dados de obra ja existente
        function update_obra() {
            event.preventDefault();  // Isso evita o comportamento padrão do formulário
            console.log('Iniciado update_obra()');  // Para depuração
            const formData = new FormData(document.getElementById('formDados'));
            const data = Object.fromEntries(formData.entries());
            const nome_obra = data.nome_obra;
            console.log('nome obra: ' + nome_obra);  // Para depuração
            fetch(`http://localhost:3000/api/dados/${encodeURIComponent(nome_obra)}`, {  // Certifique-se de codificar o nome_obra
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao atualizar dados: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                reload_table();  // Recarrega a tabela após a atualização
            })
            .catch((error) => {
                console.error('Erro:', error);  // Melhor usar console para debugar
                alert(error.message);
            });
            document.getElementById('formDados').reset()
            console.log('Finalizado update_obra()');  // Para depuração
        }

        //enviar post para inserir novo pavimento
        function insert_pavimento() {
            event.preventDefault();
            console.log(`Iniciando insert_bd_obra()`);
            const formData = new FormData(document.getElementById('pavimento'));
            const data = Object.fromEntries(formData.entries());
            console.log(data)
            fetch('http://localhost:3000/api/pavimentos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                console.log('response: ',response)
                if (!response.ok) {
                    throw new Error('Erro ao inserir dados: ' + response.statusText)
                }
                return response.json()
            })
            .then(data => {
                alert(data.message);
                reload_table();
            })
            .catch((error) => {
                alert(error);
                });
            console.log(`Finalizado insert_pavimento()`);
            document.getElementById('pavimento').reset()
        }
    </script>
</body>
</html>
